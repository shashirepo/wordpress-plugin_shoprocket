<?php
$rule = new ShoprocketShippingRule();
$method = new ShoprocketShippingMethod();
$rate = new ShoprocketShippingRate();
$product = new ShoprocketProduct();
$tab = 1;

if($_SERVER['REQUEST_METHOD'] == "POST") {
  if($_POST['shoprocket-action'] == 'save rule') {
    $rule->setData($_POST['rule']);
    $rule->save();
    $rule->clear();
  }
  elseif($_POST['shoprocket-action'] == 'save shipping validation') {
    ShoprocketSetting::setValue('require_shipping_validation', $_POST['require_shipping_validation']);
    ShoprocketSetting::setValue('require_shipping_validation_label', $_POST['require_shipping_validation_label']);
  }
  elseif($_POST['shoprocket-action'] == 'save shipping method') {
    if(isset($_POST['shipping_method']['countries'])) {
      foreach($_POST['shipping_method']['countries'] as $post_country) {
        $post_country = explode('~', $post_country);
        $post_countries[$post_country[0]] = $post_country[1];
      }
      $_POST['shipping_method']['countries'] = serialize($post_countries);
    }
    $method->setData($_POST['shipping_method']);
    $method->save();
    $method->clear();
  }
  elseif($_POST['shoprocket-action'] == 'save product rate') {
    $rate->setData($_POST['rate']);
    $rate->save();
    $rate->clear();
  }
  elseif($_POST['shoprocket-action'] == 'save local pickup info') {
    foreach($_POST['local'] as $key => $value) {
      ShoprocketSetting::setValue($key, $value);
    }
    $tab = 6;
  }
  elseif($_POST['shoprocket-action'] == 'save ups account info') {
    foreach($_POST['ups'] as $key => $value) {
      ShoprocketSetting::setValue($key, $value);
    }
    $methods = (isset($_POST['ups_methods'])) ? $_POST['ups_methods'] : false;
    $codes = array();
    if(is_array($methods)) {
      foreach($methods as $methodData) {
        list($code, $name) = explode('~', $methodData);
        $m = new ShoprocketShippingMethod();
        $m->code = $code;
        $m->name = $name;
        $m->carrier = 'ups';
        $m->save();
        $codes[] = $code;
      }
    }
    else {
      $codes[] = -1;
    }
    $method->pruneCarrierMethods('ups', $codes);
    $tab = 2;
  }
  elseif($_POST['shoprocket-action'] == 'save usps account info') {
    foreach($_POST['ups'] as $key => $value) {
      ShoprocketSetting::setValue($key, $value);
    }
    
    $methods = $_POST['usps_methods'];
    $codes = array();
    if(is_array($methods)) {
      foreach($methods as $methodData) {
        list($code, $name) = explode('~', $methodData);
        $m = new ShoprocketShippingMethod();
        $m->code = $code;
        $m->name = $name;
        $m->carrier = 'usps';
        $m->save();
        $codes[] = $code;
      }
    }
    else {
      $codes[] = -1;
    }
    $method->pruneCarrierMethods('usps', $codes);
    $tab = 1;
  }
  elseif($_POST['shoprocket-action'] == 'save fedex account info') {
    foreach($_POST['fedex'] as $key => $value) {
      ShoprocketSetting::setValue($key, $value);
    }
    
    $methods = (isset($_POST['fedex_methods'])) ? $_POST['fedex_methods'] : false;
    $codes = array();
    if(is_array($methods)) {
      foreach($methods as $methodData) {
        list($code, $name) = explode('~', $methodData);
        $m = new ShoprocketShippingMethod();
        $m->code = $code;
        $m->name = $name;
        $m->carrier = 'fedex';
        $m->save();
        $codes[] = $code;
      }
    }
    else {
      $codes[] = -1;
    }
    $method->pruneCarrierMethods('fedex', $codes);
    
    $intlMethods = (isset($_POST['fedex_methods_intl'])) ? $_POST['fedex_methods_intl'] : false;
    $intlCodes = array();
    if(is_array($intlMethods)) {
      foreach($intlMethods as $methodData) {
        list($code, $name) = explode('~', $methodData);
        $m = new ShoprocketShippingMethod();
        $m->code = $code;
        $m->name = $name;
        $m->carrier = 'fedex_intl';
        $m->save();
        $intlCodes[] = $code;
      }
    }
    else {
      $intlCodes[] = -1;
    }
    $method->pruneCarrierMethods('fedex_intl', $intlCodes);
    
    $tab = 3;
  }
  elseif($_POST['shoprocket-action'] == 'save aupost account info') {
    foreach($_POST['aupost'] as $key => $value) {
      ShoprocketSetting::setValue($key, $value);
    }
    $methods = (isset($_POST['aupost_methods'])) ? $_POST['aupost_methods'] : false;
    $codes = array();
    if(is_array($methods)) {
      foreach($methods as $methodData) {
        list($code, $name) = explode('~', $methodData);
        $m = new ShoprocketShippingMethod();
        $m->code = $code;
        $m->name = $name;
        $m->carrier = 'aupost';
        $m->save();
        $codes[] = $code;
      }
    }
    else {
      $codes[] = -1;
    }
    $method->pruneCarrierMethods('aupost', $codes);
    
    $intlMethods = (isset($_POST['aupost_methods_intl'])) ? $_POST['aupost_methods_intl'] : false;
    $intlCodes = array();
    if(is_array($intlMethods)) {
      foreach($intlMethods as $methodData) {
        list($code, $name) = explode('~', $methodData);
        $m = new ShoprocketShippingMethod();
        $m->code = $code;
        $m->name = $name;
        $m->carrier = 'aupost_intl';
        $m->save();
        $intlCodes[] = $code;
      }
    }
    else {
      $intlCodes[] = -1;
    }
    $method->pruneCarrierMethods('aupost_intl', $intlCodes);
    
    $tab = 4;
  }
  elseif($_POST['shoprocket-action'] == 'save capost account info') {
    foreach($_POST['capost'] as $key => $value) {
      ShoprocketSetting::setValue($key, $value);
    }
    $methods = (isset($_POST['capost_methods'])) ? $_POST['capost_methods'] : false;
    $codes = array();
    if(is_array($methods)) {
      foreach($methods as $methodData) {
        list($code, $name) = explode('~', $methodData);
        $m = new ShoprocketShippingMethod();
        $m->code = $code;
        $m->name = $name;
        $m->carrier = 'capost';
        $m->save();
        $codes[] = $code;
      }
    }
    else {
      $codes[] = -1;
    }
    $method->pruneCarrierMethods('capost', $codes);
    
    $intlMethods = (isset($_POST['capost_methods_intl'])) ? $_POST['capost_methods_intl'] : false;
    $intlCodes = array();
    if(is_array($intlMethods)) {
      foreach($intlMethods as $methodData) {
        list($code, $name) = explode('~', $methodData);
        $m = new ShoprocketShippingMethod();
        $m->code = $code;
        $m->name = $name;
        $m->carrier = 'capost_intl';
        $m->save();
        $intlCodes[] = $code;
      }
    }
    else {
      $intlCodes[] = -1;
    }
    $method->pruneCarrierMethods('capost_intl', $intlCodes);
    
    $tab = 5;
  }
  elseif($_POST['shoprocket-action'] == 'enable live rates') {
    ShoprocketSetting::setValue('use_live_rates', 1);
  }
  elseif($_POST['shoprocket-action'] == 'disable live rates') {
    ShoprocketSetting::setValue('use_live_rates', '');
  }
  elseif($_POST['shoprocket-action'] == 'save rate tweak') {
    ShoprocketCommon::log('[' . basename(__FILE__) . ' - line ' . __LINE__ . "] Saving a rate tweak");
    $factor = ShoprocketCommon::postVal('rate_tweak_factor');
    if(is_numeric($factor)) {
      ShoprocketSetting::setValue('rate_tweak_factor', $factor);
      ShoprocketSetting::setValue('rate_tweak_type', ShoprocketCommon::postVal('rate_tweak_type'));
    }
    else {
      ShoprocketSetting::setValue('rate_tweak_factor', '');
      ShoprocketSetting::setValue('rate_tweak_type', '');
    }
    $tab = 7;
  }
}
elseif(isset($_GET['task']) && $_GET['task'] == 'edit' && isset($_GET['id']) && $_GET['id'] > 0) {
  $id = ShoprocketCommon::getVal('id');
  $rule->load($id);
}
elseif(isset($_GET['task']) && $_GET['task'] == 'edit_method' && isset($_GET['id']) && $_GET['id'] > 0) {
  $id = ShoprocketCommon::getVal('id');
  $method->load($id);
}
elseif(isset($_GET['task']) && $_GET['task'] == 'edit_rate' && isset($_GET['id']) && $_GET['id'] > 0) {
  $id = ShoprocketCommon::getVal('id');
  $rate->load($id);
}
elseif(isset($_GET['task']) && $_GET['task'] == 'delete' && isset($_GET['id']) && $_GET['id'] > 0) {
  $id = ShoprocketCommon::getVal('id');
  $rule->load($id);
  $rule->deleteMe();
  $rule->clear();
}
elseif(isset($_GET['task']) && $_GET['task'] == 'delete_method' && isset($_GET['id']) && $_GET['id'] > 0) {
  $id = ShoprocketCommon::getVal('id');
  $method->load($id);
  $method->deleteMe();
  $method->clear();
}
elseif(isset($_GET['task']) && $_GET['task'] == 'delete_rate' && isset($_GET['id']) && $_GET['id'] > 0) {
  $id = ShoprocketCommon::getVal('id');
  $rate->load($id);
  $rate->deleteMe();
  $rate->clear();
}
?>
<h2>Shoprocket Shipping</h2>
<div class='wrap'>

  <?php if(false): ?>
  <div style="padding: 10px; 25px; width: 580px; background-color: #EEE; border: 1px solid #CCC; -moz-border-radius: 5px; -webkit-border-radius: 5px;">
    <h3><?php _e( 'Live Shipping Rates' , 'shoprocket' ); ?></h3>
  
    <p><?php _e( 'Using live shipping rates overrides all other types of shipping settings.' , 'shoprocket' ); ?></p>
  
    <?php if(ShoprocketSetting::getValue('use_live_rates')): ?>
      <form action="admin.php?page=shoprocket-shipping" method="post">
        <p><?php _e( 'Live shipping rates are enabled.' , 'shoprocket' ); ?></p>
        <input type='hidden' name='shoprocket-action' value='disable live rates' />
        <input type="submit" name="submit" value="Disable Live Shipping Rates" id="submit" class="button-secondary" />
      </form>
    <?php else: ?>
      <form action="admin.php?page=shoprocket-shipping" method="post">
        <p><?php _e( 'Live shipping rates are not enabled.' , 'shoprocket' ); ?></p>
        <input type='hidden' name='shoprocket-action' value='enable live rates' />
        <input type="submit" name="submit" value="Enable Live Shipping Rates" id="submit" class="button-primary" />
      </form>
    <?php endif; ?>
  </div>
  <?php endif; ?>
  
  <?php 
  if(false && ShoprocketSetting::getValue('use_live_rates')):
    require_once(SHOPROCKET_PATH . "/pro/admin/shipping.php");  
  else: ?>
    <?php if(false): ?>
      <h3 style="clear: both;"><?php _e( 'Shipping Validation' , 'shoprocket' ); ?></h3>
      <p style="width: 400px;"><?php _e( 'Set the options here whether or not to require shipping validation on the cart page.' , 'shoprocket' ); ?></p> 

      <form action="admin.php?page=shoprocket-shipping" method='post'>
        <input type='hidden' name='shoprocket-action' value='save shipping validation' />
      
        <table class="form-table">
          <tbody>
          
            <tr valign="top">
              <th scope="row"><?php _e('Shipping Validation', 'shoprocket'); ?></th>
              <td>
                <input type="radio" value="1" name="require_shipping_validation" id="require_shipping_validation_yes"<?php echo ShoprocketSetting::getValue('require_shipping_validation') == 1 ? ' checked="checked"' : ''; ?> />
                <label for="require_shipping_validation_yes"><?php _e('Yes', 'shoprocket'); ?></label>
                <input type="radio" value="0" name="require_shipping_validation" id="require_shipping_validation_no"<?php echo ShoprocketSetting::getValue('require_shipping_validation') != 1 ? ' checked="checked"' : ''; ?> />
                <label for="require_shipping_validation_no"><?php _e('No', 'shoprocket'); ?></label>
              </td>
            </tr>
            <tr valign="top">
              <th scope="row"><?php _e('Validation Label', 'shoprocket'); ?></th>
              <td>
                <input type="test" name="require_shipping_validation_label" value="<?php echo ShoprocketSetting::getValue('require_shipping_validation_label'); ?>" />
                <p class="description"><?php _e('Enter the label for the option that asks the customer to select a shipping method and rate.  Default: Select a Shipping Method', 'shoprocket'); ?></p>
              </td>
            </tr>
            <tr valign="top">
              <th scope="row"></th>
              <td>
                <?php submit_button(__('Save', 'shoprocket')); ?>
              </td>
            </tr>
          </tbody>
        </table>
    
      </form>
    <?php endif; ?>
    <h3 style="clear: both;"><?php _e( 'Shipping Methods' , 'shoprocket' ); ?></h3>
    <p style="width: 400px;"><?php _e( 'Create the shipping methods you will offer your customers. If no shipping price is defined for a product, the default rates entered here will be used to calculate shipping costs.' , 'shoprocket' ); ?></p> 

    <form action="admin.php?page=shoprocket-shipping" method='post'>
      <input type='hidden' name='shoprocket-action' value='save shipping method' />
      <input type='hidden' name='shipping_method[id]' value='<?php echo $method->id ?>' />
      
      <table class="form-table">
        <tbody>
          <tr valign="top">
            <th scope="row"><?php _e( 'Shipping method' , 'shoprocket' ); ?></th>
            <td>
              <input type="text" name="shipping_method[name]" value="<?php echo $method->name ?>" />
              <span class="label_desc"><?php _e( 'ex. FedEx Ground' , 'shoprocket' ); ?></span>
            </td>
          </tr>
          <tr valign="top">
            <th scope="row"><?php _e( 'Default rate' , 'shoprocket' ); ?></th>
            <td>
              <span><?php echo ShoprocketCommon::currencySymbol('before'); ?></span>
              <input type="text" name="shipping_method[default_rate]" value="<?php echo $method->default_rate ?>" style='width: 80px;'/>
              <span><?php echo ShoprocketCommon::currencySymbol('after'); ?></span>
              <span class="label_desc"><?php _e( 'Rate if only one item is ordered' , 'shoprocket' ); ?></span>
            </td>
          </tr>
          <tr valign="top">
            <th scope="row"><?php _e('Default bundle rate', 'shoprocket'); ?></th>
            <td>
              <span><?php echo ShoprocketCommon::currencySymbol('before'); ?></span>
              <input type="text" name="shipping_method[default_bundle_rate]" value="<?php echo $method->default_bundle_rate ?>" style='width: 80px;'/>
              <span><?php echo ShoprocketCommon::currencySymbol('after'); ?></span>
              <span class="label_desc"><?php _e( 'Rate for each additional item' , 'shoprocket' ); ?></span>
            </td>
          </tr>
          <?php
          $countryList = unserialize($method->countries);
          $countryList = $countryList ? $countryList : array();
          $countries = array_filter(explode(',', ShoprocketSetting::getValue('countries')));
          ?>
          <?php if(count($countries) > 0 && ShoprocketSetting::getValue('international_sales')): ?>
            <tr valign="top" class="eligible_countries_block">
              <th scope="row"><?php _e('Eligible Countries', 'shoprocket'); ?></th>
              <td>
                <select id="countries" name="shipping_method[countries][]" class="multiselect" multiple="multiple">
                  <?php
                
                  foreach($countries as $c) {
                    $ship_country = explode('~', $c);
                    $ship_to_countries[$ship_country[0]] = $ship_country[1];
                  }
                  foreach($ship_to_countries as $code => $country): ?>
                    <?php 
                      $selected = (in_array($country, $countryList)) ? 'selected="selected"' : '';
                      if(!empty($code)):
                    ?>
                      <option value="<?php echo $code . '~' . $country; ?>" <?php echo $selected ?>><?php echo $country ?></option>
                    <?php endif; ?>
                  <?php endforeach; ?>
                </select>
                <span class="description"><?php _e('Select which countries you want this shipping method to apply to. Leave blank to apply to all countries. Only the countries selected in the main settings will appear in this list.', 'shoprocket'); ?></span>
              </td>
            </tr>
          <?php endif; ?>
          <tr valign="top">
            <th scope="row"></th>
            <td>
              <?php if($method->id > 0): ?>
              <a href='?page=shoprocket-shipping' class='button-secondary linkButton' style=""><?php _e( 'Cancel' , 'shoprocket' ); ?></a>
              <?php endif; ?>
              <input type='submit' name='submit' class="button-primary" style='width: 60px;' value='<?php _e( 'Save' , 'shoprocket' ); ?>' />
            </td>
          </tr>
        </tbody>
      </table>
      <br />
    </form>
    
    <?php
    $methods = $method->getModels("where code IS NULL or code = ''", 'order by default_rate');
    if(count($methods)):
    ?>
    <table class="widefat" style='width: 600px;'>
    <thead>
      <tr>
    		<th><?php _e( 'Shipping Method' , 'shoprocket' ); ?></th>
    		<th><?php _e( 'Default rate' , 'shoprocket' ); ?></th>
    		<th><?php _e( 'Default bundle rate' , 'shoprocket' ); ?></th>
        <th>&nbsp;</th>
    	</tr>
    </thead>
    <tbody>
      <?php foreach($methods as $m): ?>
        <tr>
          <td><?php echo $m->name ?></td>
          <td><?php echo ShoprocketCommon::currency($m->default_rate); ?></td>
          <td><?php echo ShoprocketCommon::currency($m->default_bundle_rate); ?></td>
          <td>
           <a href='?page=shoprocket-shipping&task=edit_method&id=<?php echo $m->id ?>'><?php _e( 'Edit' , 'shoprocket' ); ?></a> | 
           <a class='delete' href='?page=shoprocket-shipping&task=delete_method&id=<?php echo $m->id ?>'><?php _e( 'Delete' , 'shoprocket' ); ?></a>
          </td>
        </tr>
      <?php endforeach; ?>
    </tbody>
    </table>
    <?php endif; ?>

    <h3 style="clear: both;"><?php _e( 'Product Shipping Prices' , 'shoprocket' ); ?></h3>

    <p style="width: 400px;"><?php _e( 'The shipping prices you set up here override the default shipping prices for the shipping methods above.' , 'shoprocket' ); ?></p>
    
    <?php
      $products = ShoprocketProduct::loadProductsOutsideOfClass();
      if(count($method->getModels()) && count($products)): ?>
      <form action="admin.php?page=shoprocket-shipping" method='post'>
        <input type="hidden" name="shoprocket-action" value="save product rate" />
        <input type="hidden" name="rate[id]" value="<?php echo $rate->id ?>" id="rate-id" />
        <ul>
          <li>
            <label class="med"><?php _e( 'Product' , 'shoprocket' ); ?>:</label>
            <select name='rate[product_id]'>
              <?php foreach($products as $p): ?>
                <option value="<?php echo $p->id; ?>" <?php echo ($p->id == $rate->product_id) ? 'selected="selected"' : '' ?>><?php echo $p->name ?> (<?php echo $p->item_number ?>)</option>
              <?php endforeach; ?>
            </select>
          </li>
          <li>
            <label class="med"><?php _e( 'Shipping method' , 'shoprocket' ); ?>:</label>
            <select name='rate[shipping_method_id]'>
              <?php foreach($method->getModels("where carrier = ''", 'order by name') as $m): ?>
                <option value="<?php echo $m->id; ?>" <?php echo ($m->id == $rate->shipping_method_id) ? 'selected="selected"' : '' ?>><?php echo $m->name ?></option>
              <?php endforeach; ?>
            </select>
          </li>
          <li>
            <label class="med"><?php _e( 'Shipping rate' , 'shoprocket' ); ?>:</label>
            <span><?php echo ShoprocketCommon::currencySymbol('before'); ?></span>
            <input type="text" style="width: 80px;" name="rate[shipping_rate]" value="<?php echo $rate->shipping_rate ?>" />
            <span><?php echo ShoprocketCommon::currencySymbol('after'); ?></span>
          </li>
          <li>
            <label class="med">Shipping bundle rate:</label>
            <span><?php echo ShoprocketCommon::currencySymbol('before'); ?></span>
            <input type="text" style="width: 80px;" name="rate[shipping_bundle_rate]" value="<?php echo $rate->shipping_bundle_rate ?>" />
            <span><?php echo ShoprocketCommon::currencySymbol('after'); ?></span>
          </li>
          <li>
            <label class="med">&nbsp;</label>
            <?php if($rate->id > 0): ?>
              <a href='?page=shoprocket-shipping' class='button-secondary linkButton' style="">Cancel</a>
            <?php endif; ?>
            <input type='submit' name='submit' class="button-primary" style='width: 60px;' value='Save' />
          </li>
        </ul>
      </form>
    <?php else: ?>
      <p style="color: red;"><?php _e( 'You must enter at least one shipping method and at least one product for these setting to appear.' , 'shoprocket' ); ?></p>
    <?php endif; ?>

    <?php
    $rates = $rate->getModels(null, 'order by product_id, shipping_method_id');
    if(count($rates)):
    ?>
    <table class="widefat" style='width: auto;'>
    <thead>
      <tr>
    		<th><?php _e( 'Product' , 'shoprocket' ); ?></th>
    		<th><?php _e( 'Shipping method' , 'shoprocket' ); ?></th>
    		<th><?php _e( 'Rate' , 'shoprocket' ); ?></th>
    		<th><?php _e( 'Bundle rate' , 'shoprocket' ); ?></th>
        <th>&nbsp;</th>
    	</tr>
    </thead>
    <tbody>
      <?php foreach($rates as $r): ?>
        <?php 
          $product->load($r->product_id);
          $method->load($r->shipping_method_id);
        ?>
        <tr>
          <td><?php echo $product->item_number ?> <?php echo $product->name ?></td>
          <td><?php echo $method->name ?></td>
          <td><?php echo ShoprocketCommon::currency($r->shipping_rate); ?></td>
          <td><?php echo ShoprocketCommon::currency($r->shipping_bundle_rate); ?></td>
          <td>
           <a href='?page=shoprocket-shipping&task=edit_rate&id=<?php echo $r->id ?>'><?php _e( 'Edit' , 'shoprocket' ); ?></a> | 
           <a class='delete' href='?page=shoprocket-shipping&task=delete_rate&id=<?php echo $r->id ?>'><?php _e( 'Delete' , 'shoprocket' ); ?></a>
          </td>
        </tr>
      <?php endforeach; ?>
    </tbody>
    </table>
    <?php endif; ?>
    <h3 style="clear: both;"><?php _e( 'Cart Price Shipping Rates' , 'shoprocket' ); ?></h3>

    <p style='width: 400px;'><?php echo __( 'You can set the shipping cost based on the total cart value. For example, you 
      may want to offer free shipping on orders over ', 'shoprocket') . ShoprocketCommon::currency(50) . '. ' . __('To do that set minimum cart amount to', 'shoprocket') . ' ' . ShoprocketCommon::currency(50) . __(' and the shipping cost to ', 'shoprocket') . ShoprocketCommon::currency(0) . '.'?></p> 
    <p style='width: 400px;'><?php echo __( 'You can also set up tiered shipping costs based on the cart amount. For example,
      if you want to charge $10 shipping on orders between ', 'shoprocket') . ShoprocketCommon::currency(0) . ' - ' . ShoprocketCommon::currency(24.99) . __(' and ', 'shoprocket') . ShoprocketCommon::currency(5) . __(' shipping on orders between ', 'shoprocket') . ShoprocketCommon::currency(25) . ' - ' . ShoprocketCommon::currency(49.99) . __(' and free shipping on orders ', 'shoprocket') . ShoprocketCommon::currency(50) . __(' or more you would set that up with three shipping rules as follows.' , 'shoprocket' ); ?></p>
    
    <table style='width: 400px; margin-bottom: 20px;'>
      <tr>
        <th style='text-align: left;'><?php _e( 'Minimum cart amount' , 'shoprocket' ); ?></th>
        <th style='text-align: left;'><?php _e( 'Shipping cost' , 'shoprocket' ); ?></th>
      </tr>
      <tr>
        <td><?php echo ShoprocketCommon::currency(0); ?></td>
        <td><?php echo ShoprocketCommon::currency(10); ?></td>
      </tr>
      <tr>
        <td><?php echo ShoprocketCommon::currency(25); ?></td>
        <td><?php echo ShoprocketCommon::currency(5); ?></td>
      </tr>
      <tr>
        <td><?php echo ShoprocketCommon::currency(50); ?></td>
        <td><?php echo ShoprocketCommon::currency(0); ?></td>
      </tr>
    </table>

    <?php if(count($method->getModels())): ?>
    <form action="admin.php?page=shoprocket-shipping" method='post'>
      <input type='hidden' name='shoprocket-action' value='save rule' />
      <input type='hidden' name='rule[id]' value='<?php echo $rule->id ?>' />
      <ul>
        <li>
          <label for="rule-min_amount"><?php _e( 'Minimum cart amount' , 'shoprocket' ); ?>:</label>
          <span><?php echo ShoprocketCommon::currencySymbol('before'); ?></span>
          <input type='text' name='rule[min_amount]' id='rule-min_amount' style='width: 80px;' value='<?php echo $rule->minAmount ?>' />
          <span><?php echo ShoprocketCommon::currencySymbol('after'); ?></span>
        </li>
        <li>
          <label class="med"><?php _e( 'Shipping method' , 'shoprocket' ); ?>:</label>
          <select name="rule[shipping_method_id]">
            <?php foreach($method->getModels(null, 'name') as $m): ?>
              <option value="<?php echo $m->id; ?>"><?php echo $m->name ?></option>
            <?php endforeach; ?>
          </select>
        </li>
        <li>
          <label class="med" for="rule-shipping_cost"><?php _e( 'Shipping cost' , 'shoprocket' ); ?>:</label>
          <span><?php echo ShoprocketCommon::currencySymbol('before'); ?></span>
          <input type="text" id="rule-shipping_cost" name="rule[shipping_cost]" style="width: 80px;" value="<?php echo $rule->shippingCost ?>" />
          <span><?php echo ShoprocketCommon::currencySymbol('after'); ?></span>
        </li>
        <li>
          <label class="med">&nbsp;</label>
          <?php if($rule->id > 0): ?>
          <a href='?page=shoprocket-shipping' class='button-secondary linkButton' style=""><?php _e( 'Cancel' , 'shoprocket' ); ?></a>
          <?php endif; ?>
          <input type='submit' name='submit' class="button-primary" style='width: 60px;' value='Save' />
        </li>
      </ul>
    </form>
    <?php else: ?>
      <p style='color: red;'><?php _e( 'You must have entered at least one shipping method before you can configure these settings.' , 'shoprocket' ); ?></p>
    <?php endif; ?>
  
    <?php
    $rules = $rule->getModels(null, 'order by min_amount');
    if(count($rules)):
    ?>
      <table class="widefat" style='width: auto;'>
        <thead>
        	<tr>
        		<th><?php _e( 'Minimum cart amount' , 'shoprocket' ); ?></th>
        		<th><?php _e( 'Shipping method' , 'shoprocket' ); ?></th>
        		<th><?php _e( 'Shipping cost' , 'shoprocket' ); ?></th>
        		<th><?php _e( 'Actions' , 'shoprocket' ); ?></th>
        	</tr>
        </thead>
        <tbody>
          <?php foreach($rules as $rule): ?>
            <?php 
              $method = new ShoprocketShippingMethod();
              $method->load($rule->shipping_method_id);
            ?>
           <tr>
             <td><?php echo ShoprocketCommon::currency($rule->min_amount); ?></td>
             <td><?php echo ($method->name) ? $method->name : "<span style='color:red;'>Please select a method</span>"; ?></td>
             <td><?php echo ShoprocketCommon::currency($rule->shipping_cost); ?></td>
             <td>
               <a href='?page=shoprocket-shipping&task=edit&id=<?php echo $rule->id ?>'><?php _e( 'Edit' , 'shoprocket' ); ?></a> | 
               <a class='delete' href='?page=shoprocket-shipping&task=delete&id=<?php echo $rule->id ?>'><?php _e( 'Delete' , 'shoprocket' ); ?></a>
             </td>
           </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    <?php endif; ?>
    
  <?php endif; ?>

  
</div>

<script type="text/javascript">
  (function($){
    $(document).ready(function(){
      
      $(".multiselect").multiselect({sortable: true});
      
      $('div.sh<?php echo $tab; ?>').show();
  	  
  	  $('div.loading').hide();
  	  $('div.shoprocketTabbed ul.tabs li.sh<?php echo $tab; ?> a').addClass('current');  	  
      // SHIPPING TABS
      $('div.shoprocketTabbed ul li a.tab').click(function(){
  	    var thisClass = this.className.slice(0,3);
  	    $('div.pane').hide();
  	    $('div.' + thisClass).fadeIn(300);
  	    $('div.shoprocketTabbed ul.tabs li a').removeClass('current');
  	    $('div.shoprocketTabbed ul.tabs li a.' + thisClass).addClass('current');
  	  });
      
      $('#ups_clear_all').click(function() {
        $('.ups_shipping_options').attr('checked', false);
        return false;
      });

      $('#ups_select_all').click(function() {
        $('.ups_shipping_options').attr('checked', true);
        return false;
      });

      $('#usps_clear_all').click(function() {
        $('.usps_shipping_options').attr('checked', false);
        return false;
      });

      $('#usps_select_all').click(function() {
        $('.usps_shipping_options').attr('checked', true);
        return false;
      });
      
      $('#ups_pickup_code').val("<?php echo ShoprocketSetting::getValue('ups_pickup_code'); ?>");
      $('#fedex_pickup_code').val("<?php echo ShoprocketSetting::getValue('fedex_pickup_code'); ?>");
      $('#fedex_location_type').val("<?php echo ShoprocketSetting::getValue('fedex_location_type'); ?>");
      
      $('#fedex_clear_all').click(function() {
        $('.fedex_shipping_options').attr('checked', false);
        return false;
      });

      $('#fedex_select_all').click(function() {
        $('.fedex_shipping_options').attr('checked', true);
        return false;
      });
      
      $('#aupost_clear_all').click(function() {
        $('.aupost_shipping_options').attr('checked', false);
        return false;
      });

      $('#aupost_select_all').click(function() {
        $('.aupost_shipping_options').attr('checked', true);
        return false;
      });
      
      $('#capost_clear_all').click(function() {
        $('.capost_shipping_options').attr('checked', false);
        return false;
      });

      $('#capost_select_all').click(function() {
        $('.capost_shipping_options').attr('checked', true);
        return false;
      });
      
      setRateTweakerSymbol();

      $('#rate_tweak_type').change(function() {
        setRateTweakerSymbol();
      });
    })
    $('.what_is').click(function() {
      $('#' + $(this).attr('id') + '_answer').toggle('slow');
      return false;
    });

    $('.delete').click(function() {
      return confirm('Are you sure you want to delete this entry?');
    });
  })(jQuery);
</script>